version: '3.4'

services:
  api:
    image: calciumion/new-api:latest
    environment:
      # 使用Coolify的魔法环境变量进行服务发现和密码管理
      - SQL_DSN=${SERVICE_PASSWORD_MYSQL}@tcp(${SERVICE_FQDN_MYSQL})/new-api
      - REDIS_CONN_STRING=redis://${SERVICE_FQDN_REDIS}
      - TZ=Asia/Shanghai
      - SESSION_SECRET=${SERVICE_PASSWORD_64_API}
      # 可选环境变量
      - NODE_TYPE=${NODE_TYPE:-master}
      - SYNC_FREQUENCY=${SYNC_FREQUENCY:-60}
      - FRONTEND_BASE_URL=${FRONTEND_URL:-http://localhost:3000}
    volumes:
      # 使用bind类型的卷，并让Coolify自动创建目录
      - type: bind
        source: ./data
        target: /data
        is_directory: true
      - type: bind
        source: ./logs
        target: /app/logs
        is_directory: true
    command: --log-dir /app/logs
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:3000/api/status | grep -o '\"success\":\\s*true' | awk -F: '{print $2}'"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - redis
      - mysql

  redis:
    image: redis:latest
    volumes:
      - type: bind
        source: ./redis-data
        target: /data
        is_directory: true
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  mysql:
    image: mysql:8.2
    environment:
      - MYSQL_ROOT_PASSWORD=${SERVICE_PASSWORD_MYSQL}
      - MYSQL_DATABASE=new-api
    volumes:
      - type: bind
        source: ./mysql-data
        target: /var/lib/mysql
        is_directory: true
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${SERVICE_PASSWORD_MYSQL}"]
      interval: 30s
      timeout: 10s
      retries: 3
